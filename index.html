<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>地震の揺れの伝わり方シミュレーター v1.4.1</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --p-color: #3498db; --s-color: #e67e22; --bg-color: #f0f2f5; --quiz-bg: #fff0f0; }
        body { font-family: 'Hiragino Kaku Gothic ProN', sans-serif; background: var(--bg-color); margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; }
        .container { max-width: 900px; width: 100%; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 8px 30px rgba(0,0,0,0.15); border: 4px solid transparent; }
        .quiz-active { background: var(--quiz-bg); border-color: #e74c3c; }
        
        h1 { text-align: center; color: #2c3e50; font-size: 1.4rem; margin-bottom: 15px; }
        .mode-indicator { text-align: center; font-weight: bold; margin-bottom: 10px; padding: 8px; border-radius: 5px; display: none; background: #e74c3c; color: white; }


        .layout { display: grid; grid-template-columns: 1fr 300px; gap: 20px; }
        .screen { position: relative; width: 100%; height: 160px; background: #222; border-radius: 10px; overflow: hidden; margin-bottom: 15px; border: 3px solid #444; }
        canvas#simCanvas { width: 100%; height: 100%; }


        .card { background: #fdfdfd; padding: 12px; border-radius: 10px; border: 1px solid #ddd; margin-bottom: 10px; }
        button { width: 100%; padding: 12px; font-size: 0.95rem; cursor: pointer; border: none; border-radius: 8px; background: #2ecc71; color: white; font-weight: bold; margin-bottom: 8px; }
        .btn-quiz { background: #8e44ad; }
        .btn-compare { background: #2980b9; }
        .btn-hint { background: #95a5a6; padding: 5px; font-size: 0.8rem; }


        .result-panel { background: #34495e; color: #fff; padding: 15px; border-radius: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-weight: bold; font-size: 0.8rem; }
        .val { color: #f1c40f; font-size: 1.1rem; }
        .intensity-tag { grid-column: span 2; text-align: center; border-top: 1px solid #555; padding-top: 10px; }
        #shindo-val { font-size: 1.4rem; color: #ffcc00; }


        #quiz-answer-area { display: none; text-align: center; padding: 10px; background: #fff; border: 2px dashed #e74c3c; border-radius: 10px; margin-top: 10px; }
        
        @keyframes shake-p { 0% { transform: translate(var(--amp-p), var(--amp-p)); } 50% { transform: translate(calc(-1 * var(--amp-p)), calc(-1 * var(--amp-p))); } 100% { transform: translate(var(--amp-p), calc(-1 * var(--amp-p))); } }
        @keyframes shake-s { 0% { transform: translate(var(--amp-s), var(--amp-s)); } 50% { transform: translate(calc(-1 * var(--amp-s)), calc(-1 * var(--amp-s))); } 100% { transform: translate(var(--amp-s), calc(-1 * var(--amp-s))); } }
        .shake { animation: shake-p 0.08s infinite; border-color: var(--p-color) !important; }
        .shake-big { animation: shake-s 0.12s infinite; border-color: var(--s-color) !important; }
    </style>
</head>
<body>


<div class="container" id="main-container">
    <div id="mode-text" class="mode-indicator">数値計算クイズ中：震源からの距離を当ててください</div>
    <h1>地震の揺れの伝わり方シミュレーター v1.4.1</h1>


    <div class="layout">
        <div class="left-col">
            <div class="screen" id="display-screen">
                <canvas id="simCanvas"></canvas>
            </div>
            
            <div class="result-panel">
                <div>P波到着: <span id="p-arrival" class="val">0.0</span> 秒</div>
                <div>S波到着: <span id="s-arrival" class="val">0.0</span> 秒</div>
                <div>初期微動継続時間: <span id="ps-duration" class="val">0.0</span> 秒</div>
                <div class="intensity-tag">推定震度: <span id="shindo-val">--</span></div>
            </div>


            <div id="quiz-answer-area">
                <h3 style="margin:0 0 10px 0;">震源からの距離は何km？</h3>
                <input type="number" id="quiz-input" style="padding:10px; width:100px; font-size:1rem;" placeholder="???">
                <button onclick="checkAnswer()" style="width:auto; padding: 8px 20px; margin-left:10px;">回答</button>
            </div>


            <div style="height: 380px; margin-top: 15px; background: white; padding: 10px; border-radius: 10px;">
                <canvas id="travelChart"></canvas>
            </div>
        </div>


        <div class="right-col">
            <div class="card">
                <label>震源からの距離: <span id="dist-val" style="color:#e74c3c; font-weight:bold;">360</span> km</label>
                <input type="range" id="dist-slider" min="60" max="720" step="60" value="360" style="width:100%">
                
                <label style="display:block; margin-top:10px;">マグニチュード: <span id="mag-val" style="color:#e67e22; font-weight:bold;">6.0</span></label>
                <input type="range" id="mag-slider" min="4.0" max="9.0" step="0.5" value="6.0" style="width:100%">
                
                <button onclick="startSim()" style="margin-top:15px;">地震を発生させる</button>
                <button class="btn-quiz" onclick="toggleQuiz()">クイズモード切替</button>
                <button class="btn-compare" onclick="startCompareMode()">3地点比較モード</button>
            </div>


            <div class="card">
                <button class="btn-hint" onclick="showHint()">計算のヒント</button>
                <p id="hint-text" style="display:none; font-size: 0.8rem; color: #7f8c8d; margin-top: 5px; font-weight:bold;"></p>
                <div id="feedback" style="margin-top:10px; font-weight:bold; text-align:center;"></div>
            </div>
        </div>
    </div>
</div>


<script>
    const VP = 6.0; const VS = 3.0;
    let distance = 360; let magnitude = 6.0;
    let isRunning = false; let quizMode = false; let compareMode = false;
    let animationId = null;


    const simCanvas = document.getElementById('simCanvas');
    const sCtx = simCanvas.getContext('2d');
    const ctxChart = document.getElementById('travelChart').getContext('2d');


    const chart = new Chart(ctxChart, {
        type: 'line',
        data: { datasets: [] },
        options: { 
            responsive: true, maintainAspectRatio: false, animation: false,
            scales: { 
                x: { type: 'linear', min: 0, max: 240, title: {display: true, text: '経過時間 (秒)'} }, 
                y: { min: 0, max: 500, title: {display: true, text: '震源からの距離 (km)'} } 
            },
            plugins: { legend: { display: true } }
        }
    });


    function init() {
        simCanvas.width = simCanvas.offsetWidth; simCanvas.height = simCanvas.offsetHeight;
        resetChart('normal');
        drawStatic(0,0);
    }


    function resetChart(mode) {
        chart.data.datasets = [];
        if (mode === 'compare') {
            chart.options.scales.y.max = 500;
            chart.data.datasets.push(
                { label: '地点A (120km)', borderColor: '#1abc9c', data: [], borderWidth: 1.5, pointRadius: 0 },
                { label: '地点B (240km)', borderColor: '#f1c40f', data: [], borderWidth: 1.5, pointRadius: 0 },
                { label: '地点C (360km)', borderColor: '#e74c3c', data: [], borderWidth: 1.5, pointRadius: 0 }
            );
        } else {
            chart.options.scales.y.max = 800;
            chart.data.datasets.push(
                { label: 'P波', borderColor: '#3498db', data: [], borderWidth: 3, pointRadius: 0 },
                { label: 'S波', borderColor: '#e67e22', data: [], borderWidth: 3, pointRadius: 0 },
                { label: '距離線', borderColor: '#e74c3c', data: [], borderWidth: 2, borderDash: [5, 5], pointRadius: 0 }
            );
        }
        chart.update();
    }


    function calculateIntensity(m, d) {
        let intensity = 2.0 * m - 4.8 * Math.log10(d) + 2.1;
        if (intensity < 0) return "0";
        if (intensity < 0.5) return "0";
        if (intensity < 1.5) return "1";
        if (intensity < 2.5) return "2";
        if (intensity < 3.5) return "3";
        if (intensity < 4.5) return "4";
        if (intensity < 5.0) return "5弱";
        if (intensity < 5.5) return "5強";
        if (intensity < 6.0) return "6弱";
        if (intensity < 6.5) return "6強";
        return "7";
    }


    function drawStatic(pr, sr) {
        sCtx.clearRect(0,0,simCanvas.width, simCanvas.height);
        const originX = 60; const centerY = simCanvas.height/2; const maxW = simCanvas.width - 120;
        const currentYMax = compareMode ? 500 : 800;
        
        sCtx.fillStyle="#fff"; sCtx.font="bold 14px sans-serif"; sCtx.fillText("震源", originX-10, centerY-40);
        sCtx.font="30px Arial"; sCtx.fillText("💥", originX-15, centerY+10);
        
        if (!compareMode) {
            const tx = originX + (distance/currentYMax)*maxW;
            sCtx.fillStyle="#2ed573"; sCtx.fillRect(tx, centerY-30, 12, 60);
            sCtx.fillStyle="#fff"; sCtx.fillText(quizMode?"??? km":distance+" km", tx-15, centerY-40);
        } else {
            [120, 240, 360].forEach((d, i) => {
                const tx = originX + (d/currentYMax)*maxW;
                sCtx.fillStyle=["#1abc9c","#f1c40f","#e74c3c"][i];
                sCtx.fillRect(tx, centerY-20, 8, 40);
                sCtx.fillStyle="#fff"; sCtx.font="10px sans-serif"; sCtx.fillText(d+"km", tx-10, centerY-25);
            });
        }
        if(pr>0) { sCtx.strokeStyle="rgba(52,152,219,0.5)"; sCtx.beginPath(); sCtx.arc(originX,centerY,(pr/currentYMax)*maxW,0,Math.PI*2); sCtx.stroke(); }
        if(sr>0) { sCtx.strokeStyle="rgba(230,126,34,0.5)"; sCtx.beginPath(); sCtx.arc(originX,centerY,(sr/currentYMax)*maxW,0,Math.PI*2); sCtx.stroke(); }
    }


    function clearCounters() {
        document.getElementById('p-arrival').innerText = "0.0";
        document.getElementById('s-arrival').innerText = "0.0";
        document.getElementById('ps-duration').innerText = "0.0";
        document.getElementById('shindo-val').innerText = "--";
        document.getElementById('feedback').innerText = "";
    }


    function startSim() {
        compareMode = false;
        if(animationId) cancelAnimationFrame(animationId);
        clearCounters();
        resetChart('normal');
        runAnimation(distance);
    }


    function startCompareMode() {
        compareMode = true; quizMode = false;
        document.getElementById('main-container').classList.remove('quiz-active');
        document.getElementById('mode-text').style.display = 'none';
        document.getElementById('quiz-answer-area').style.display = 'none';
        if(animationId) cancelAnimationFrame(animationId);
        clearCounters();
        resetChart('compare');
        runAnimation(null);
    }


    function runAnimation(targetDist) {
        isRunning = true; let startTime = Date.now();
        const ampBase = Math.pow(2, magnitude - 5);
        document.documentElement.style.setProperty('--amp-p', (ampBase*0.5)+'px');
        document.documentElement.style.setProperty('--amp-s', (ampBase*2.0)+'px');


        function animate() {
            let elapsed = (Date.now() - startTime) / 1000 * 10;
            const dp = VP * elapsed; const ds = VS * elapsed;
            drawStatic(dp, ds);


            if (compareMode) {
                [120, 240, 360].forEach((d, i) => {
                    let yBase = d; 
                    let wave = 0;
                    const distFactor = Math.pow(120 / d, 1.5); 
                    if (elapsed >= d/VP) {
                        const pDecay = Math.exp(-(elapsed - d/VP) * 0.05);
                        wave += (Math.random()-0.5) * (ampBase * 15 * distFactor) * pDecay;
                    }
                    if (elapsed >= d/VS) {
                        const timeAfterS = elapsed - (d/VS);
                        const sDecay = Math.exp(-timeAfterS * 0.15); 
                        if (sDecay > 0.001) {
                            wave += (Math.random()-0.5) * (ampBase * 100 * distFactor) * sDecay;
                        }
                    }
                    chart.data.datasets[i].data.push({x: elapsed, y: yBase + wave});
                });
            } else {
                chart.data.datasets[0].data.push({x:elapsed, y:dp});
                chart.data.datasets[1].data.push({x:elapsed, y:ds});
                // クイズモード以外の場合のみ、距離線（赤い破線）を更新
                if (!quizMode) {
                    chart.data.datasets[2].data = [{x:0, y:targetDist}, {x:240, y:targetDist}];
                } else {
                    chart.data.datasets[2].data = [];
                }
                updateCounters(elapsed, targetDist);
            }


            chart.update('none');
            if(elapsed >= 240) { isRunning = false; return; }
            if(isRunning) animationId = requestAnimationFrame(animate);
        }
        animate();
    }


    function updateCounters(elapsed, dist) {
        const ap = dist/VP; const as = dist/VS;
        const scr = document.getElementById('display-screen');
        const shindoDisp = document.getElementById('shindo-val');


        if(elapsed < ap) { 
            document.getElementById('p-arrival').innerText = elapsed.toFixed(1); 
            shindoDisp.innerText = "待機中";
        }
        else { 
            document.getElementById('p-arrival').innerText = ap.toFixed(1);
            if(elapsed < as) {
                scr.className = 'screen shake';
                shindoDisp.innerText = "計数中...";
            }
        }
        if(elapsed < as) { 
            document.getElementById('s-arrival').innerText = elapsed.toFixed(1);
            if(elapsed >= ap) document.getElementById('ps-duration').innerText = (elapsed-ap).toFixed(1);
        } else {
            document.getElementById('s-arrival').innerText = as.toFixed(1);
            document.getElementById('ps-duration').innerText = (as-ap).toFixed(1);
            scr.className = (elapsed < as + 3.0) ? 'screen shake-big' : 'screen';
            shindoDisp.innerText = calculateIntensity(magnitude, dist);
        }
    }


    function toggleQuiz() {
        quizMode = !quizMode; compareMode = false;
        const container = document.getElementById('main-container');
        const ansArea = document.getElementById('quiz-answer-area');
        const indicator = document.getElementById('mode-text');
        
        if(quizMode) {
            container.classList.add('quiz-active');
            ansArea.style.display = 'block';
            indicator.style.display = 'block';
            quizTarget = (Math.floor(Math.random() * 8) + 3) * 60;
            distance = quizTarget;
            document.getElementById('dist-val').innerText = "???";
            startSim();
        } else {
            container.classList.remove('quiz-active');
            ansArea.style.display = 'none';
            indicator.style.display = 'none';
            distance = parseInt(document.getElementById('dist-slider').value);
            document.getElementById('dist-val').innerText = distance;
            init();
        }
    }


    function checkAnswer() {
        const val = parseInt(document.getElementById('quiz-input').value);
        const fb = document.getElementById('feedback');
        if(val === quizTarget) {
            fb.innerText = "🎉 正解！ " + quizTarget + "km です！";
            fb.style.color = "#27ae60";
        } else {
            fb.innerText = "❌ 残念！正解は " + quizTarget + "km でした。";
            fb.style.color = "#e74c3c";
        }
    }


    function showHint() {
        const h = document.getElementById('hint-text');
        h.innerText = "ヒント：初期微動継続時間 × P波の速さ";
        h.style.display = 'block';
    }


    document.getElementById('dist-slider').addEventListener('input', (e) => {
        if(quizMode) return;
        distance = parseInt(e.target.value);
        document.getElementById('dist-val').innerText = distance;
        drawStatic(0,0);
    });


    document.getElementById('mag-slider').addEventListener('input', (e) => {
        magnitude = parseFloat(e.target.value);
        document.getElementById('mag-val').innerText = magnitude.toFixed(1);
    });


    window.addEventListener('resize', init);
    init();
</script>
</body>
</html>